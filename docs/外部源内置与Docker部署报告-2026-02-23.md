# 外部源内置与 Docker 部署报告（2026-02-23）

## 1. 目标
- 将 `d:/code/yingshi` 下用于当前接入链路的外部目录，完整镜像到 `drpy-node` 仓库内部。
- 消除 `ctf-local-adapter` 对仓库外同级目录的硬依赖，保证 Docker/CI 镜像独立可运行。
- 输出可复核的落盘报告与严格测试结果，并推送到 GitHub 用于镜像构建。

## 2. 本次内置目录
内置目标目录：`external/workspace-sources`

同步目录（11 个）：
- `.4kvm.tv`
- `.cz233.com`
- `.netflixgc.com`
- `播剧影视`
- `独播库`
- `aiyifan`
- `bgm.girigirilove.com`
- `kuangren.us`
- `kanbot.com`
- `iyf.tv`
- `libvio`

## 3. 实施改造
### 3.1 新增同步脚本
- 新增：`scripts/test/internalize-external-sources.mjs`
- 能力：
  - 从外部工作区镜像目录到 `external/workspace-sources`
  - 默认清理目标后全量重建（避免陈旧文件）
  - 跳过无业务价值目录：`.git`、`node_modules`、`__pycache__` 等
  - 过滤明显敏感文件（例如令牌文本、`aiyifan/worker-bonus/tmp_*`，保留 `tmp_fetch_regression.json`）
  - 输出落盘报告：`reports/external-internalize/<batch>/summary.md`

### 3.2 ctf 适配器改造为“内置优先”
- 修改：`controllers/ctf-local-adapter.js`
- 变更点：
  - 新增 `resolveWorkspaceRoot()`，优先级：
    1. `CTF_LOCAL_WORKSPACE_ROOT`（显式环境变量）
    2. `external/workspace-sources`（仓库内置目录）
    3. 旧路径 `../`（兼容历史）
  - `libvio` 的 last-good 缓存改为写入 `data/ctf-local-adapter/libvio-last-good.json`（仓库根内）
  - `/ctf-adapter/health` 增加 `workspace_source` 和 `workspace_markers`，用于判定实际使用来源

### 3.3 外部迁移默认扫描目录修正
- 修改：`scripts/test/external-source-migration.mjs`
- 默认优先扫描 `external/workspace-sources`，不存在时才回退 `../`

### 3.4 Git 追踪修正
- 修改：`.gitignore`
- 移除对 `data/settings/link_data.json` 的忽略，允许接入结果入库与进入镜像构建上下文

### 3.5 命令入口补充
- 修改：`package.json`
- 新增：
  - `npm run sources:internalize`
  - `npm run sources:migrate:internal`

## 4. 落盘执行记录（实测）
### 4.1 内置同步
- 批次：`20260223-093856`
- 报告：`reports/external-internalize/20260223-093856/summary.md`
- 结果：
  - 目录：11/11 成功
  - 文件：36
  - 体积：0.30 MB
  - 缺失目录：0
  - 模式：`safe-runtime-only`（只保留运行链路所需文件，默认剔除敏感/临时凭据文件）

### 4.2 ctf 严格并发验证
- 批次：`20260223-093947`
- 报告：`reports/ctf-local-adapter-strict-validation/20260223-093947/summary.md`
- 结果：
  - total=11
  - success=11
  - error=0
  - requiredPassed=319/319
  - 覆盖：搜索、分页、详情、播放探测（严格必选断言）

## 5. 安全处理
- 已移除明显敏感文件（包括真实 Bearer Token/临时注册凭据类文件）后再准备推送 GitHub。
- 当前仓库仍保留用于业务运行的必要外部快照与脚本，不影响 ctf-local 11 源链路。

## 6. 部署使用方式（镜像侧）
1. 推送到 GitHub `main`，触发 `.github/workflows/build-docker.yml`
2. 服务器拉取新镜像并重启：
   - `docker compose --env-file .env.docker pull`
   - `docker compose --env-file .env.docker up -d`
3. 验证：
   - `curl http://127.0.0.1:5757/health`
   - `curl http://127.0.0.1:5757/ctf-adapter/health`
   - 确认 `workspace_source=internal`
