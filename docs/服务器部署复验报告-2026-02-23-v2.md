# 服务器部署复验报告（2026-02-23 v2）

## 1. 目标
- 使用仓库源码在服务器本地构建镜像并运行（非远程公共镜像）。
- 验证 `ctf-local-adapter` 使用仓库内置目录 `external/workspace-sources`。
- 对接入源执行严格实测（搜索/分页/详情/播放探测）。

## 2. 环境与版本
- 服务器：`38.55.177.254`
- 部署目录：`/code/drpy-node`
- Docker 镜像：`drpy-node:local`
- 关键提交：
  - `cdb73b0`：Docker pull policy 可配置
  - `eff7c64`：默认剔除失效源（`ysxq/kanbot/libvio`）

## 3. 部署验证（实测）
- `docker compose --env-file .env.docker ps`：容器 `drpy-node` 为 `Up (healthy)`
- `curl http://127.0.0.1:5757/health`：`status=ok`
- `curl http://127.0.0.1:5757/ctf-adapter/health`：
  - `workspace_source=internal`
  - `all_site_count=11`
  - `site_count=8`

## 4. 严格测试批次与结论
- 首轮（全 11 源）：`reports/ctf-local-adapter-strict-validation/20260223-095928/summary.md`
  - `total=11, success=8, error=3, requiredChecks=316/319`
  - 失败源：`ysxq`、`kanbot`、`libvio`
- 复验后（默认 8 源）：`reports/ctf-local-adapter-strict-validation/20260223-100918/summary.md`
  - `total=8, success=8, error=0, requiredPassed=232/232`

## 5. 失败源分析与处理
- `ysxq`：播放探测 `HTTP 403`
- `kanbot`：播放探测 `HTTP 404/403`
- `libvio`：播放探测 `fetch failed`，且 Python 抓取脚本依赖 `playwright`（当前服务器未安装）
- 在服务器对候选 m3u8 直连探测（含常见 Referer/Origin）仍为 `403/404`，判定当前不可稳定提供服务。
- 已按策略默认剔除以上 3 源，但保留可恢复开关：
  - `CTF_LOCAL_INCLUDE_UNSTABLE=1`
  - `CTF_LOCAL_ADAPTER_SITE_IDS=<comma list>`

## 6. 当前默认可用源
- `kvm4`
- `cz233`
- `netflixgc`
- `dbkk`
- `aiyifan`
- `bgm`
- `kuangren`
- `iyf`

